select product_id, coalesce(round(totalpricesum/unitssum,2), 0) as average_price from (select product_id, sum(units) as unitssum, sum(totalPrice) as totalpricesum from (select Prices.product_id, units, price*units as totalPrice from Prices left outer join UnitsSold on Prices.product_id = UnitsSold.product_id and purchase_date between start_date and end_date) as newTable group by product_id) as newTable2 